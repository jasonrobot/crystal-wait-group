{"repository_name":"github.com/jasonrobot/crystal-wait-group","body":"# crystal-wait-group\n\nThis is a Crystal implementation of golang's sync.WaitGroup\n\nThere's probably still some work that needs to be done here, but it seems to work pretty well!\n\n## Installation\n\n1. Add the dependency to your `shard.yml`:\n\n   ```yaml\n   dependencies:\n     crystal-wait-group:\n       github: jasonrobot/crystal-wait-group\n   ```\n\n2. Run `shards install`\n\n## Usage\n\n```crystal\nrequire \"crystal-wait-group\"\n```\n\nTo use like Go's WaitGroup, there are the `add`, `done`, and `wait` methods. They should work just as expected.\n\n```\nwg = WaitGroup.new\nwg.add\nspawn do\n  sleep 1\n  wg.done\nend\nwg.wait\n```\n\nAs a fun crystal-style addition, there is also a `spawn` method which takes a block and spawns it in a fiber that is waited for by the WaitGroup.\n\n```\nwg = WaitGroup.new\nwg.spawn do\n  sleep 1\nend\nwg.wait\n```\n\n## Development\n\nAll feedback is welcome! This is my first time playing with concurrency at this level, or doing low-level Crystal stuff, so there's gotta be room for improvment. The usage of `Intrinsics.pause` is taken from `Crystal::SpinLock`. Basically what I've gone for here is a version of SpinLock built around an atomic counter.\n\n## Contributing\n\n1. Fork it (<https://github.com/jasonrobot/crystal-wait-group/fork>)\n2. Create your feature branch (`git checkout -b my-new-feature`)\n3. Commit your changes (`git commit -am 'Add some feature'`)\n4. Push to the branch (`git push origin my-new-feature`)\n5. Create a new Pull Request\n\n## Contributors\n\n- [Jason Howell](https://github.com/jasonrobot) - creator and maintainer\n","program":{"html_id":"github.com/jasonrobot/crystal-wait-group/toplevel","path":"toplevel.html","kind":"module","full_name":"Top Level Namespace","name":"Top Level Namespace","abstract":false,"superclass":null,"ancestors":[],"locations":[],"repository_name":"github.com/jasonrobot/crystal-wait-group","program":true,"enum":false,"alias":false,"aliased":"","const":false,"constants":[],"included_modules":[],"extended_modules":[],"subclasses":[],"including_types":[],"namespace":null,"doc":null,"summary":null,"class_methods":[],"constructors":[],"instance_methods":[],"macros":[],"types":[{"html_id":"github.com/jasonrobot/crystal-wait-group/WaitGroup","path":"WaitGroup.html","kind":"class","full_name":"WaitGroup","name":"WaitGroup","abstract":false,"superclass":{"html_id":"github.com/jasonrobot/crystal-wait-group/Reference","kind":"class","full_name":"Reference","name":"Reference"},"ancestors":[{"html_id":"github.com/jasonrobot/crystal-wait-group/Reference","kind":"class","full_name":"Reference","name":"Reference"},{"html_id":"github.com/jasonrobot/crystal-wait-group/Object","kind":"class","full_name":"Object","name":"Object"}],"locations":[{"filename":"crystal-wait-group.cr","line_number":25,"url":"https://github.com/jasonrobot/crystal-wait-group/blob/745c68380af7492bc1d59bf75b640c33e4e96759/src/crystal-wait-group.cr"}],"repository_name":"github.com/jasonrobot/crystal-wait-group","program":false,"enum":false,"alias":false,"aliased":"","const":false,"constants":[],"included_modules":[],"extended_modules":[],"subclasses":[],"including_types":[],"namespace":null,"doc":"WaitGroup can be used to wait for a number of different fibers to complete.\n\nMultiple fibers can be waited for, and multiple fibers can be waiting. Once\nthere are no fibers being waited for\n\n```\nwg = WaitGroup.new\nwg.spawn do\n  sleep 1\n  puts \"slept for 1\"\nend\n\nwg.add\nspawn do\n  sleep 2\n  puts \"slept for 2\"\n  wg.done\nend\n\nwg.wait\nputs \"done waiting\"\n```","summary":"<p>WaitGroup can be used to wait for a number of different fibers to complete.</p>","class_methods":[],"constructors":[],"instance_methods":[{"id":"add(delta=1)-instance-method","html_id":"add(delta=1)-instance-method","name":"add","doc":"Add `delta` to the number of fibers being waited for.\n\nDelta should be positive. Use `done` instead to decrement the counter.","summary":"<p>Add <code>delta</code> to the number of fibers being waited for.</p>","abstract":false,"args":[{"name":"delta","doc":null,"default_value":"1","external_name":"delta","restriction":""}],"args_string":"(delta = <span class=\"n\">1</span>)","source_link":"https://github.com/jasonrobot/crystal-wait-group/blob/745c68380af7492bc1d59bf75b640c33e4e96759/src/crystal-wait-group.cr#L34","def":{"name":"add","args":[{"name":"delta","doc":null,"default_value":"1","external_name":"delta","restriction":""}],"double_splat":null,"splat_index":null,"yields":null,"block_arg":null,"return_type":"","visibility":"Public","body":"@mutex.synchronize do\n  @state = @state + delta\nend"}},{"id":"done-instance-method","html_id":"done-instance-method","name":"done","doc":"Decrease the number of fibers being waited for by 1.\n\nThis should be called from within the spawned fiber that's being waited for.\nOnce there are 0 fibers being waited for, all waiting fibers will be restarted.\n\nRaises an error if the counter goes below 0.","summary":"<p>Decrease the number of fibers being waited for by 1.</p>","abstract":false,"args":[],"args_string":"","source_link":"https://github.com/jasonrobot/crystal-wait-group/blob/745c68380af7492bc1d59bf75b640c33e4e96759/src/crystal-wait-group.cr#L47","def":{"name":"done","args":[],"double_splat":null,"splat_index":null,"yields":null,"block_arg":null,"return_type":"","visibility":"Public","body":"@mutex.synchronize do\n  @state = @state - 1\n  if @state < 0\n    raise(\"Tried to decrement the number of fibers in a wait group below zero.\")\n  end\n  if @state == 0\n    wake_waiting_fibers\n  end\nend"}},{"id":"spawn(&block)-instance-method","html_id":"spawn(&amp;block)-instance-method","name":"spawn","doc":"Spawn a block in a fiber, calling `add` before it is spawned, and `done`\nonce it completes.","summary":"<p>Spawn a block in a fiber, calling <code><a href=\"WaitGroup.html#add(delta=1)-instance-method\">#add</a></code> before it is spawned, and <code><a href=\"WaitGroup.html#done-instance-method\">#done</a></code> once it completes.</p>","abstract":false,"args":[],"args_string":"(&block)","source_link":"https://github.com/jasonrobot/crystal-wait-group/blob/745c68380af7492bc1d59bf75b640c33e4e96759/src/crystal-wait-group.cr#L89","def":{"name":"spawn","args":[],"double_splat":null,"splat_index":null,"yields":0,"block_arg":{"name":"block","doc":null,"default_value":"","external_name":"block","restriction":""},"return_type":"","visibility":"Public","body":"add\n::spawn do\n  begin\n    block.call\n  ensure\n    done\n  end\nend\n"}},{"id":"wait-instance-method","html_id":"wait-instance-method","name":"wait","doc":"Pause the current fiber until there are no fibers being waited for.\n\nIf the counter is 0, `wait` will return immediately without blocking.\nMultiple fibers can wait on the same wait group.","summary":"<p>Pause the current fiber until there are no fibers being waited for.</p>","abstract":false,"args":[],"args_string":"","source_link":"https://github.com/jasonrobot/crystal-wait-group/blob/745c68380af7492bc1d59bf75b640c33e4e96759/src/crystal-wait-group.cr#L69","def":{"name":"wait","args":[],"double_splat":null,"splat_index":null,"yields":null,"block_arg":null,"return_type":"","visibility":"Public","body":"should_wait = false\n@mutex.synchronize do\n  if @state == 0\n  else\n    @waiting_fibers << Fiber.current\n    should_wait = true\n  end\nend\nif should_wait\n  Crystal::Scheduler.reschedule\nend\n"}}],"macros":[],"types":[]}]}}